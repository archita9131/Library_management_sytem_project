<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Library Admin Dashboard</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
*{margin:0;padding:0;box-sizing:border-box;font-family:"Segoe UI",sans-serif}
body{
  background:linear-gradient(135deg,#667eea,#764ba2);
  min-height:100vh;
  color:#333;
}

/* HEADER */
.header{
  backdrop-filter:blur(10px);
  background:rgba(255,255,255,0.1);
  color:white;
  padding:15px 25px;
  display:flex;
  align-items:center;
  box-shadow:0 4px 20px rgba(0,0,0,0.15);
}
.menu-btn{font-size:26px;cursor:pointer;margin-right:15px}
.header h2{font-weight:600}
#loggedUser{margin-left:auto;margin-right:20px;font-weight:500}

.logout-btn{
  background:#ef4444;
  border:none;
  color:white;
  padding:8px 14px;
  border-radius:6px;
  cursor:pointer;
  font-weight:600;
}
.logout-btn:hover{background:#dc2626}

/* SIDEBAR */
.sidebar{
  position:fixed;top:0;left:-260px;width:260px;height:100vh;
  background:#1e293b;color:white;padding-top:70px;transition:.4s;z-index:10;
}
.sidebar.active{left:0}
.sidebar h3{text-align:center;margin-bottom:20px;font-weight:600}
.sidebar a{
  display:block;padding:14px 22px;color:#cbd5e1;text-decoration:none;transition:.2s;
}
.sidebar a:hover{background:#334155;padding-left:28px;color:white}

/* OVERLAY */
.overlay{
  position:fixed;top:0;left:0;width:100%;height:100%;
  background:rgba(0,0,0,.4);display:none;z-index:5;
}
.overlay.active{display:block}

/* MAIN */
.main{padding:30px}
.page{display:none}
.page.active{display:block}

/* STATS */
.stats{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(220px,1fr));
  gap:20px;margin-bottom:30px;
}
.stat-box{
  backdrop-filter:blur(10px);
  background:rgba(255,255,255,0.85);
  padding:22px;border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
  text-align:center;transition:.3s;
}
.stat-box:hover{transform:translateY(-5px)}
.stat-box strong{display:block;font-size:26px;margin-top:10px}
.pending{background:#fff4e5;color:#b45309}

/* CARDS */
.card{
  backdrop-filter:blur(14px);
  background:rgba(255,255,255,0.9);
  padding:25px;border-radius:18px;
  box-shadow:0 10px 25px rgba(0,0,0,0.15);
  margin-bottom:25px;
}
.card h3{margin-bottom:20px;color:#4c51bf}

/* TABLE */
table{width:100%;border-collapse:collapse;border-radius:12px;overflow:hidden}
th{background:#667eea;color:white;padding:12px}
td{padding:12px;background:white}
tr:nth-child(even) td{background:#f8fafc}
.empty{color:#777}
.fine{color:#b91c1c;font-weight:bold}

/* FORM */
input{
  padding:10px;margin:8px 5px 0 0;
  border-radius:8px;border:1px solid #ddd;
}
button{
  padding:10px 16px;border:none;border-radius:8px;
  background:#667eea;color:white;font-weight:600;cursor:pointer;
}
button:hover{background:#5a67d8}
</style>
</head>

<body>

<div class="header">
  <span class="menu-btn" onclick="toggleSidebar()">‚ò∞</span>
  <h2>üìö Library Admin Dashboard</h2>
  <div id="loggedUser">Loading...</div>
  <button class="logout-btn" onclick="logout()">Logout</button>
</div>

<div class="sidebar" id="sidebar">
  <h3>Admin Panel</h3>
  <a onclick="openPage('dashboard')">üè† Dashboard</a>
  <a onclick="openPage('add')">‚ûï Add Book</a>
  <a onclick="openPage('books')">üìñ Available Books</a>
  <a onclick="openPage('issue')">üì• Issue Requests</a>
  <a onclick="openPage('report')">üìä Return Report</a>
</div>

<div class="overlay" id="overlay" onclick="toggleSidebar()"></div>

<div class="main">

<div id="dashboard" class="page active">
  <div class="stats">
    <div class="stat-box">üìö Books Issued<strong id="issuedCount">0</strong></div>
    <div class="stat-box">üì• Books Returned<strong id="returnedCount">0</strong></div>
    <div class="stat-box pending">‚è≥ Pending Requests<strong id="pendingCount">0</strong></div>
    <div class="stat-box">üë• Members<strong id="memberCount">0</strong></div>
  </div>

  <div class="card">
    <h3>üë• User Activity</h3>
    <table id="activityTable"></table>
  </div>
</div>

<div id="add" class="page">
  <div class="card">
    <h3>‚ûï Add Book</h3>
    <input id="bookName" placeholder="Book Name">
    <input id="authorName" placeholder="Author Name">
    <input id="quantity" placeholder="Quantity">
    <button onclick="addBook()">Add Book</button>
  </div>
</div>

<div id="books" class="page">
  <div class="card">
    <h3>üìñ Available Books</h3>
    <table id="booksTable"></table>
  </div>
</div>

<div id="issue" class="page">
  <div class="card">
    <h3>üì• Issue Requests</h3>
    <table id="issueTable"></table>
  </div>
</div>

<div id="report" class="page">
  <div class="card">
    <h3>üìä Return Report</h3>
    <table id="returnReportTable"></table>
  </div>
</div>

</div>

<script>

const sidebar = document.getElementById("sidebar");
const overlay = document.getElementById("overlay");
const loggedUser = document.getElementById("loggedUser");

function toggleSidebar(){
  sidebar.classList.toggle("active");
  overlay.classList.toggle("active");
}
function openPage(id){
  document.querySelectorAll(".page").forEach(p=>p.classList.remove("active"));
  document.getElementById(id).classList.add("active");
  toggleSidebar();
  
  if(id === "report"){
      loadReturnReports();   // ‚úÖ load when clicking report
  }
}

async function addBook(){
  const res = await fetch("/api/add-book", {
    method:"POST",
    headers:{"Content-Type":"application/json"},
    body:JSON.stringify({
      name:bookName.value,
      author:authorName.value,
      qty:quantity.value
    })
  });

  alert("Book Added!");
  bookName.value="";
  authorName.value="";
  quantity.value="";
}


/* ‚úÖ LOGOUT (Backend Ready) */
async function logout(){
  try{
    await fetch("/api/logout",{method:"POST"});
  }catch(e){console.log("Backend not connected yet")}
  window.location.href="index.html"; // Home/Login page
}

/* Load Logged User */
async function loadLoggedUser(){
  try{
    const res=await fetch("/api/me");
    const data=await res.json();
    loggedUser.textContent="üë§ "+data.username;
  }catch{
    loggedUser.textContent="";
  }
}

/* Other dashboard functions remain same */
loadLoggedUser();

async function loadAdminDashboard(){
  const res = await fetch("/api/admin-data");
  const data = await res.json();

  if(data.error){
    alert("Login as admin first");
    window.location.href="/index.html";
    return;
  }

  // Counts
 document.getElementById("issuedCount").innerText = data.issued;
 document.getElementById("returnedCount").innerText = data.returned;
 document.getElementById("pendingCount").innerText = data.pending;
 document.getElementById("memberCount").innerText = data.users;

  // Books Table
  let html = "<tr><th>Name</th><th>Author</th><th>Qty</th></tr>";
  data.books.forEach(b=>{
    html += `<tr><td>${b.name}</td><td>${b.author}</td><td>${b.qty}</td></tr>`;
  });

  document.getElementById("booksTable").innerHTML = html;
}

loadAdminDashboard();

async function loadIssueRequests(){
  const res = await fetch("/api/admin-requests");
  const data = await res.json();

  let html = "<tr><th>User</th><th>Book</th><th>Date</th><th>Action</th></tr>";

  if(data.length === 0){
    html += `<tr><td colspan="4" class="empty">No requests</td></tr>`;
  }

  data.forEach(r=>{
    html += `
      <tr>
        <td>${r.username}</td>
        <td>${r.book_name}</td>
        <td>${r.request_date}</td>
        <td>
          <button onclick="approve(${r.request_id})">Approve</button>
        </td>
      </tr>
    `;
  });

  document.getElementById("issueTable").innerHTML = html;
}

async function approve(id){
  await fetch("/api/approve-issue/" + id, {method:"POST"});
  alert("Approved");
  loadIssueRequests();
  loadAdminDashboard();
}

loadIssueRequests();
async function loadActivity(){
  const res = await fetch("/api/activity");
  const data = await res.json();

  let html = "<tr><th>ID</th><th>User</th><th>Status</th><th>Date</th></tr>";

  data.forEach(a=>{
    html += `<tr>
      <td>${a.user_id}</td>
      <td>${a.username}</td>
      <td>${a.status}</td>
      <td>${a.request_date}</td>
    </tr>`;
  });

  document.getElementById("activityTable").innerHTML = html;
}

loadActivity();
async function loadReturnReports(){
    try{
        const res = await fetch("/api/admin-returns"); // ‚úÖ correct route
        const data = await res.json();

        console.log("ADMIN RETURNS:", data);

        let html = `
            <tr>
                <th>Username</th>
                <th>Book</th>
                <th>Issue Date</th>
                <th>Return Date</th>
            </tr>
        `;

        if(data.length === 0){
            html += `<tr><td colspan="4">No return records</td></tr>`;
        }

        data.forEach(r=>{
            html += `
                <tr>
                    <td>${r.username}</td>
                    <td>${r.book_name}</td>
                    <td>${r.issue_date}</td>
                    <td>${r.return_date}</td>
                </tr>
            `;
        });

        document.getElementById("returnReportTable").innerHTML = html;

    }catch(e){
        console.log("Error loading returns", e);
    }
}


</script>

</body>
</html>




